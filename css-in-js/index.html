<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>CSS-in-JS Demo (Vanilla JS Library) - Fixed</title>
  <script>
    // 简单 hash，用于生成唯一 className / animationName
    function simpleHash(str) {
      let h = 0;
      for (let i = 0; i < str.length; i++) {
        h = ((h << 5) - h) + str.charCodeAt(i);
        h |= 0;
      }
      return "c" + Math.abs(h).toString(36);
    }

    // 获取或创建 <style>
    function getStyleEl() {
      let styleEl = document.querySelector("style[data-css-in-js]");
      if (!styleEl) {
        styleEl = document.createElement("style");
        styleEl.setAttribute("data-css-in-js", "true");
        document.head.appendChild(styleEl);
      }
      return styleEl;
    }

    // 改进版 css：将嵌套选择器抽出为独立规则
    function css(template, ...args) {
      // 合并模板字符串和插值
      let styleText = '';
      const raw = template.raw;
      for (let i = 0; i < raw.length; i++) {
        styleText += raw[i];
        if (i < args.length) styleText += args[i];
      }

      const className = simpleHash(styleText);
      const styleEl = getStyleEl();
      // 避免重复注入：检查是否存在完整的主规则标记
      if (styleEl.textContent.includes(`.${className} {`)) {
        return className;
      }

      // 提取所有以 & 开头的嵌套规则（例如 &:hover, & .child, &:hover, &:focus）
      const nestedRegex = /&([^{]*)\{([\s\S]*?)\}/g;
      let match;
      let baseProps = styleText;
      const extraRules = [];

      // 用原始 styleText 去匹配所有嵌套块
      while ((match = nestedRegex.exec(styleText)) !== null) {
        const selSuffixRaw = match[1].trim(); // 例如 ":hover" 或 ".child, :focus"
        const inner = match[2].trim();

        // 处理逗号分隔的情况： &:hover, &:focus { ... }
        const selectors = selSuffixRaw.split(',')
          .map(s => `.${className}${s.trim()}`)
          .join(', ');

        // 格式化 inner 内容（保持缩进）
        const innerLines = inner.split('\n').map(l => '  ' + l.trim()).join('\n');

        extraRules.push(`${selectors} {\n${innerLines}\n}`);

        // 从 baseProps 中删除这个嵌套块（以免重复）
        baseProps = baseProps.replace(match[0], '');
      }

      // 主规则（顶层声明）
      const mainLines = baseProps
        .split('\n')
        .map(l => l.trim())
        .filter(Boolean)
        .map(l => '  ' + l)
        .join('\n');

      let newCss = `.${className} {\n${mainLines}\n}\n`;
      if (extraRules.length) {
        newCss += extraRules.join('\n') + '\n';
      }

      // 使用 textContent 避免 HTML 解析干扰
      styleEl.textContent += newCss;

      return className;
    }

    // keyframes（保留原理，但用 textContent 防止重复）
    function keyframes(template, ...args) {
      let animText = '';
      const raw = template.raw;
      for (let i = 0; i < raw.length; i++) {
        animText += raw[i];
        if (i < args.length) animText += args[i];
      }

      const animName = "k" + simpleHash(animText);
      const styleEl = getStyleEl();
      if (!styleEl.textContent.includes(`@keyframes ${animName}`)) {
        const body = animText.split('\n').map(line => '  ' + line.trim()).join('\n');
        styleEl.textContent += `@keyframes ${animName} {\n${body}\n}\n`;
      }

      return animName;
    }

    // 等待 DOM 完全加载
    document.addEventListener('DOMContentLoaded', () => {
      console.log("DOM 已加载，开始应用样式...");

      // 按钮 1：普通 hover
      const btn1 = css`
        padding: 8px 16px;
        border: none;
        border-radius: 4px;
        background: lightblue;
        cursor: pointer;
        font-size: 16px;
        transition: all 0.2s ease;

        &:hover {
          background: deepskyblue;
          color: white;
        }
      `;
      const button1 = document.getElementById("btn1");
      // 使用 classList.add 更安全，不覆盖已有类
      button1.classList.add(btn1);
      console.log("按钮1样式应用完成，类名:", btn1);

      // 按钮 2：动态颜色
      function createButton(color) {
        return css`
          padding: 8px 16px;
          border: none;
          border-radius: 4px;
          background: ${color};
          cursor: pointer;
          font-size: 16px;
          transition: opacity 0.2s ease;

          &:hover {
            opacity: 0.7;
          }
        `;
      }
      const btn2 = createButton("orange");
      document.getElementById("btn2").classList.add(btn2);
      console.log("按钮2样式应用完成，类名:", btn2);

      // 方块
      const box = css`
        width: 100px;
        height: 100px;
        background: green;
        margin-top: 20px;
        transition: all 0.2s ease;

        &:hover {
          background: lime;
          transform: scale(1.1);
        }
      `;
      document.getElementById("box").classList.add(box);
      console.log("方块样式应用完成，类名:", box);

      // 按钮 3：带动画
      const pulse = keyframes`
        0% { transform: scale(1); }
        50% { transform: scale(0.9); }
        100% { transform: scale(1); }
      `;
      const btn3 = css`
        padding: 8px 16px;
        border: none;
        border-radius: 4px;
        background: violet;
        cursor: pointer;
        font-size: 16px;

        &:active {
          animation: ${pulse} 0.3s ease;
          background: purple;
          color: white;
        }
      `;
      document.getElementById("btn3").classList.add(btn3);
      console.log("按钮3样式应用完成，类名:", btn3, "动画名:", pulse);

      // 调试：显示生成的样式内容
      console.log("生成的样式:\n", document.querySelector("style[data-css-in-js]").textContent);
    });
  </script>
</head>
<body>
  <h1>CSS-in-JS 原生实现 (库 + 示例) - Fixed</h1>
  <button id="btn1">普通按钮</button>
  <button id="btn2">动态按钮</button>
  <button id="btn3">带动画按钮</button>
  <div id="box"></div>
</body>
</html>
