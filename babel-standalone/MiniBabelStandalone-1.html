<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Mini Babel Demo</title>
  <!-- 优化的 CSP 策略 -->
  <meta http-equiv="Content-Security-Policy" content="script-src 'self' blob: 'unsafe-eval' chrome-extension://27e24747-6f27-4bc5-a18b-c203446e1dff/; object-src 'self';">
  <script src="minibabel.js"></script>
</head>
<body>
  <div id="root"></div>
  
  <script type="text/jsx">
    /** @jsx h */
    
    // 自定义的 JSX 转换函数
    function h(tag, props, ...children) {
      if (typeof tag === 'function') {
        return tag({ ...props, children });
      }
      
      const element = document.createElement(tag);
      
      // 检查是否存在属性对象
      if (props) {
        // 遍历属性对象中的每个属性
        for (const key in props) {
          // 处理事件监听属性（以 'on' 开头且值为函数）
          if (key.startsWith('on') && typeof props[key] === 'function') {
            // 提取事件名（去掉 'on' 前缀并转为小写）
            const eventName = key.slice(2).toLowerCase();
            // 为元素添加事件监听器
            element.addEventListener(eventName, props[key]);
          } 
          // 处理样式属性（属性名为 'style' 且值为对象）
          else if (key === 'style' && typeof props[key] === 'object') {
            // 将样式对象合并到元素的 style 属性上
            Object.assign(element.style, props[key]);
          } 
          // 处理其他普通属性
          else {
            // 为元素设置属性
            element.setAttribute(key, props[key]);
          }
        }
      }
      
      // 添加子元素
      children.forEach(child => {
        if (child === null || child === undefined) return;
        
        if (typeof child === 'string' || typeof child === 'number') {
          element.appendChild(document.createTextNode(child));
        } else if (Array.isArray(child)) {
          child.forEach(nestedChild => element.appendChild(
            typeof nestedChild === 'string' || typeof nestedChild === 'number' 
              ? document.createTextNode(nestedChild) 
              : nestedChild
          ));
        } else {
          element.appendChild(child);
        }
      });
      
      return element;
    }
    
    // 简单组件
    function Counter() {
      let count = 0;
      
      function increment() {
        count++;
        render();
      }
      
      function render() {
        const root = document.getElementById('root');
        root.innerHTML = '';
        
        // 使用 JavaScript 对象替代 JSX 语法，避免复杂的转换问题
        const counterElement = h('div', null,
          h('h1', null, 'Count: ', count),
          h('button', { onClick: increment }, 'Increment')
        );
        
        root.appendChild(counterElement);
      }
      
      render();
    }
    
    // 直接调用组件，不依赖 JSX 转换
    Counter();
  </script>
</body>
</html>